<?php

require_once '../vendor/autoload.php';

use Opis\JsonSchema\{
  IMediaType, MediaTypeContainer, Schema, Validator, ValidationResult, ValidationError
};

class MimeType implements IMediaType {
  public function validate(string $data, string $type): bool {
    if ($type == 'image/jpeg') {
      $header = 'data:image/jpeg;base64,';
      if (substr($data, 0, strlen($header)) != $header)
        return false;
      $data = base64_decode(substr($data, strlen($header)));
      try {
        $image = @imagecreatefromstring($data);
        if ($image !== false) {
          $size = @getimagesizefromstring($data);
          if ($type != $size['mime'])
            return false;
          if ($size[0] != 150 || $size[1] != 200)
            return false;
          return true;
        } else
          return false;
      } catch(Exception $e) {
        return false;
      }
    }
    return false;
  }
}

function error($message) {
  if ($message[0] != '{')
    $message = '"'.$message.'"';
  die("{\"error\":$message}");
}
header("Content-Type: application/json");
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Headers: content-type");
# build a PHP variable from JSON sent using POST method

$publication = json_decode(file_get_contents("php://input"));

/*
$publication_text = '{"schema":"https://directdemocracy.vote/json-schema/0.0.1/card.schema.json","key":"-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAgUwTkqTubR4NqVFjK3i3\\nshA2xMYk19BGDPgvtiFrEjHMMYJl7OS9bcoG9oOtxf7BrRjgfcDj8zUAE13gReXo\\nW6w0splqfbzvJlcwyC28s28XjifkTy+cG+ArsGjNFeYCqDs1JDJm52/QBPZY18n+\\nCBHTaWoOfB4hk/9u3hJZ1Ykc2H+/TN2VbnManUy6aqtn4X/iKS3xNtfxNvJcSJ3O\\nL/CtPpfvBJlJw3xxwbvTUuq8BWLO+PRK6YjGQ7DYDwyyQsMcjpjbU6VTxH8TXxVB\\nFrMJ2iKm/vjW/7HvlskBXuKN5QTaDQe4fWa5COd5dQ1A4IIkPWj0B8RZ9c3B3/Kt\\n+QIDAQAB\\n-----END PUBLIC KEY-----","signature":"Q4V+cPGtwMDZ+Ye+psOhXehNVnjnv3Mdo08UcfyZIRVlKfbFnQAQPZMMJ1NLSc7EzJbz92dlfNlVdLsGZzNp+e4dHRj6xb8MxQ5NSne4oXMB/Fgc+XmU9NyYGM+jRuaHz1Y/gS6mQiWQzRNbkxc1BRQIMQ5CZPIYXN/uWbpHjmy8wsv+XKHTJlQ9CvRbUoWci0ajigXwkYQ5X0dn24/yFVMWVFW88vfh89OhhfY1QyxAADDSbrTvWVFwEUB/z9QaB+EbRrYDwh4V1+2o8PkhFUjapMprcnuDlAJwiG7HbtwOmQ061nqa3rGkQUtM3/qDKa14tAULAfLkArFDqI7rAA==","published":"2019-09-09T06:38:22.356Z","expires":"2029-09-09T06:38:22.356Z","familyName":"fdg","givenNames":"fdg","picture":"data:image/jpeg;base64,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","latitude":46517577,"longitude":6563739}';

$publication = json_decode($publication_text);
*/

if (!$publication)
  error("Unable to parse JSON post");
if (!isset($publication->schema))
  error("Unable to read schema field");

$schema_text = file_get_contents($publication->schema);
$schema = Schema::fromJsonString($schema_text);

$mediaTypes = new MediaTypeContainer();
$mimeType = new MimeType();
$mediaTypes->add("image/jpeg", $mimeType);

$validator = new Validator();
$validator->setMediaType($mediaTypes);
$result = $validator->schemaValidation($publication, $schema);
if (!$result->isValid()) {
  $error = $result->getFirstError();
  $keyword = $error->keyword();
  $keywordArgs = json_encode($error->keywordArgs(), JSON_UNESCAPED_SLASHES);
  error("{\"keyword\":\"$keyword\",\"keywordArgs\":$keywordArgs}");
}

$signature = base64_decode($publication->signature);
$key = $publication->key;
$publication->signature = '';
$data = json_encode($publication, JSON_UNESCAPED_SLASHES);
$verify = openssl_verify($data, $signature, $key, OPENSSL_ALGO_SHA256);
if ($verify != 1)
  error("Wrong signature");
echo("{ \"published\": \"URL\" }");
?>
